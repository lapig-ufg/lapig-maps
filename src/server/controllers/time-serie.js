var 	ChildProcess = 	require('child_process')
		,	async = require('async')
		, unidecode = require('unidecode');;

module.exports = function(app) {

	var TimeSerie = {};
	var config = app.config;
	var rasterTimeSeries = app.libs.rasterTimeSeries;

	TimeSerie.data = function(request, response) {
		response.send({"series":[{"position":1,"id":"original","label":"Valores originais"},{"position":2,"id":"savgol","label":"Savitzky Golay"}],"values":[["2000-02-18",1.4215544378912328,1.4439464084224383],["2000-03-05",1.5395702306079664,1.5013996255278343],["2000-03-21",1.5156809033989265,1.4958408954520892],["2000-04-06",1.3626462691859582,1.3998026408026658],["2000-04-22",1.3246929002706642,1.2899583522574358],["2000-05-08",1.2125563667597166,1.2455795912411651],["2000-05-24",1.2422086322474422,1.2283203588877445],["2000-06-09",1.2443507080445917,1.2554603715055623],["2000-06-25",1.2117134613250473,1.1785057617821002],["2000-07-11",1.0074150188846922,1.033475431253922],["2000-07-27",0.8819966688537829,0.8771372806193624],["2000-08-12",0.7819615550548871,0.7781081608389807],["2000-08-28",0.7105056840454724,0.7264517450504475],["2000-09-13",0.7157813282352408,0.6941055395393108],["2000-09-29",0.659903381642512,0.7100320714838684],["2000-10-15",0.6578709397381176,0.47314406976299495],["2000-10-31",0.2398483831770616,0.6256267406181198],["2000-11-16",1.091146908990775,0.572976574057935],["2000-12-02",0.396330210731673,0.9054507111283622],["2000-12-18",1.3852825561686322,1.0526005126148583],["2001-01-01",1.348149041775817,1.4716162056775872],["2001-01-17",1.456365272154746,1.412859699924371],["2001-02-02",1.4409166063862766,1.4768589465580109],["2001-02-18",1.540353412905632,1.5224468868970424],["2001-03-06",1.5738987581444561,1.5796151795955728],["2001-03-22",1.569685178634595,1.5558791116591701],["2001-04-07",1.4891536273115218,1.5000980815426137],["2001-04-23",1.4548158384906569,1.4714990176238394],["2001-05-09",1.4614982471246694,1.4137052633156277],["2001-05-25",1.3093901982790874,1.393655999038699],["2001-06-10",1.3562658481249168,1.2319754168112653],["2001-06-26",0.9767983439710195,1.0983575657282003],["2001-07-12",0.9957158651188502,0.9154855657410329],["2001-07-28",0.8195556703694136,0.8653324428157856],["2001-08-13",0.7908751779315761,0.7702142721296503],["2001-08-29",0.7181694608065247,0.7117290988098977],["2001-09-14",0.650977493017907,0.6590151392649546],["2001-09-30",0.7139758052166811,0.7223253705588012],["2001-10-16",0.9380683885049108,1.0376796715675314],["2001-11-01",1.2567476383265856,0.904217540223785],["2001-11-17",0.4413743143951154,0.9048753044363778],["2001-12-03",1.3761603209565765,1.1496175081659459],["2001-12-19",1.5378060117756431,1.4089984004792049],["2002-01-01",1.0460112231743386,1.3114507104339437],["2002-01-17",1.5232312565997888,1.3407535366836207],["2002-02-02",1.4951273954703834,1.5918235826271223],["2002-02-18",1.6162676555597972,1.5271888805822744],["2002-03-06",1.4130978691464078,1.4849544014636444],["2002-03-22",1.4513162432463502,1.432457111813609],["2002-04-07",1.4582947745079893,1.439718771132578],["2002-04-23",1.3814286596283263,1.4073343682724304],["2002-05-09",1.3848331346841478,1.3668954114668985],["2002-05-25",1.3303901682376806,1.3515045908805536],["2002-06-10",1.2892551663857152,1.242880646170939],["2002-06-26",1.086248604391515,1.1476029849891953],["2002-07-12",1.0872270266907236,1.0421437259885151],["2002-07-28",0.942245870746037,0.9573288593726468],["2002-08-13",0.8273324155459071,0.8157177481604749],["2002-08-29",0.7425457394349971,0.7673618957606183],["2002-09-14",0.8234493735880057,0.804797680317268],["2002-09-30",0.9160850253807107,0.9298575328441839],["2002-10-16",1.0840974903474905,1.0655474302969643],["2002-11-01",1.2304523102821954,1.283240019103646],["2002-11-17",1.4745323942348056,1.364549136298499],["2002-12-03",1.3198640483383686,1.440293104408928],["2002-12-19",1.5531115879828326,1.4598466832590982],["2003-01-01",1.5559336744016081,1.6546306175634482],["2003-01-17",1.7980795239383285,1.6872033510723703],["2003-02-02",1.5978340160484823,1.659196830572976],["2003-02-18",1.5670373802903923,1.5717006377955833],["2003-03-06",1.6016303434366068,1.576178079876196],["2003-03-22",1.543148961365767,1.5687920454870476],["2003-04-07",1.530072364827963,1.4927534956858668],["2003-04-23",1.4017103698249989,1.4529908795634847],["2003-05-09",1.4327595990164554,1.3938417058244328],["2003-05-25",1.2996440614462346,1.303468321295819],["2003-06-10",1.1328298533984895,1.14108913944017],["2003-06-26",1.0181667062455473,1.0174607811509704],["2003-07-12",0.9451460142067878,0.9588767713616246],["2003-07-28",0.911494964271648,0.8796572216071074],["2003-08-13",0.7547485766231281,0.76759054185099],["2003-08-29",0.6838822025305293,0.7112460770502247],["2003-09-14",0.7580482656047594,0.7104515043484828],["2003-09-30",0.7171539867269405,0.7456865308830917],["2003-10-16",0.8564021347680827,0.8795391654129687],["2003-11-01",1.1381157967774267,1.093892464826741],["2003-11-17",1.2546860356138705,1.3330014776452763],["2003-12-03",1.4144427868943035,1.2050093125476895],["2003-12-19",0.9120358292025393,1.2306085150257822],["2004-01-01",1.4855054751662107,1.1852205216514013],["2004-01-17",1.1562107028084392,1.3600770753276676],["2004-02-02",1.4488349478251115,1.3578718124997424],["2004-02-18",1.5096206331877728,1.5168620695017183],["2004-03-05",1.54604676066393,1.5783346072294844],["2004-03-21",1.6811089083583808,1.650547090761415],["2004-04-06",1.661111111111111,1.660000223569342],["2004-04-22",1.5889119423933606,1.6147340410627984],["2004-05-08",1.5803303303303304,1.5466335126920445],["2004-05-24",1.449927385237103,1.4720035949382722],["2004-06-09",1.4053937565420849,1.4133171765947499],["2004-06-25",1.3968643138266983,1.3725402361507895],["2004-07-11",1.2820340260579304,1.2953969947545603],["2004-07-27",1.2023787684216964,1.2212433329066137],["2004-08-12",1.1434731146432195,1.0947246749660389],["2004-08-28",0.870805052790347,0.8995483232586109],["2004-09-13",0.7185943671646917,0.7252535668727214],["2004-09-29",0.6857226866047801,0.6531020077915426],["2004-10-15",0.6933809766887867,0.7687394806493203],["2004-10-31",1.0433347891493183,0.9557181177990128],["2004-11-16",1.1581671295127494,1.2394117715758735],["2004-12-02",1.4826555023923447,1.3926253198674536],["2004-12-18",1.513723254998246,1.6308351532973346],["2005-01-01",1.798645863997645,1.6360354205894034],["2005-01-17",1.5183933259016866,1.704582916807126],["2005-02-02",1.7510574769843246,1.5835660062610248],["2005-02-18",1.4025182596227093,1.473971919460496],["2005-03-06",1.3327227746324755,1.3802245611310733],["2005-03-22",1.5679920913884007,1.5090609392037977],["2005-04-07",1.5804597701149425,1.5927410242234525],["2005-04-23",1.5297894798569167,1.5211758637968784],["2005-05-09",1.4323635917265085,1.4592200773013553],["2005-05-25",1.4050566642030058,1.3761615326144438],["2005-06-10",1.2514175907258065,1.258523418185638],["2005-06-26",1.1121051332675223,1.1387194211099159],["2005-07-12",1.0448767334360556,0.9866714312221352],["2005-07-28",0.7969898080113771,0.8628884583648881],["2005-08-13",0.7947636329358534,0.749232916277496],["2005-08-29",0.695699896694215,0.7085861631744697],["2005-09-14",0.6884919821186892,0.7128952353616246],["2005-09-30",0.8114934964385259,0.7682294731480036],["2005-10-16",0.818353425715389,0.8325765657392996],["2005-11-01",0.9674676944003626,1.074713992016445],["2005-11-17",1.3512955933322333,1.0631932889230935],["2005-12-03",0.8110896078288177,1.1832470714737235],["2005-12-19",1.5492957746478873,1.2774535529510864],["2006-01-01",1.4265230546899696,1.5251432160882614],["2006-01-17",1.4748729953182589,1.4741374680806731],["2006-02-02",1.5758785942492013,1.5748345763749183],["2006-02-18",1.6196540003043984,1.577067969323874],["2006-03-06",1.5084935708387401,1.5812160165585565],["2006-03-22",1.641528691313223,1.5788849558451536],["2006-04-07",1.569462213790974,1.6070671569539154],["2006-04-23",1.5738405707959158,1.5569682818003463],["2006-05-09",1.4974858579509742,1.490533958349048],["2006-05-25",1.380063542494043,1.3972425922753664],["2006-06-10",1.3423445870188113,1.3384534220318913],["2006-06-26",1.3046777066701853,1.30364809961122],["2006-07-12",1.2328085414404633,1.226095893362492],["2006-07-28",1.1044948136765271,1.1146984724287616],["2006-08-13",0.9758084733015794,0.9386217107673716],["2006-08-29",0.7837787847960788,0.8404359550700808],["2006-09-14",0.8992805755395684,0.8498454742610577],["2006-09-30",1.0321883530482256,1.1183239832664909],["2006-10-16",1.4691194730875128,1.3713936887980385],["2006-11-01",1.491775605543124,1.5320426492134227],["2006-11-17",1.5219925703446093,1.5096360248517575],["2006-12-03",1.5118240112680232,1.5205974061837337],["2006-12-19",1.5574832695060152,1.574958980647453],["2007-01-01",1.6528274122346018,1.6074023136654443],["2007-01-17",1.5878302099796793,1.6688956484638098],["2007-02-02",1.682424916573971,1.5311258086030708],["2007-02-18",1.3107813368686652,1.4921299429410526],["2007-03-06",1.6122255353754404,1.5056929642383472],["2007-03-22",1.6103498390947784,1.627559151096801],["2007-04-07",1.5716265716265718,1.5895010156184184],["2007-04-23",1.5617527498804402,1.530373060560891],["2007-05-09",1.4378902108611145,1.4708152209287315],["2007-05-25",1.423297166968053,1.4076402288810748],["2007-06-10",1.3571067131451706,1.3583061479055005],["2007-06-26",1.261116222017786,1.2518892110366373],["2007-07-12",1.1431296606740273,1.1709044046164478],["2007-07-28",1.118599457648748,1.0920335589665986],["2007-08-13",0.9789393621485522,0.9804172947233502],["2007-08-29",0.8254986080051117,0.8251944068150183],["2007-09-14",0.7423838823441136,0.7675879941575794],["2007-09-30",0.8172508861756598,0.7873379654879857],["2007-10-16",0.8437073493527443,0.872318866686738],["2007-11-01",0.9643450764178862,0.9016666718907542],["2007-11-17",0.9879548363503383,1.1081570922782715],["2007-12-03",1.4545754509458864,1.3582461515986242],["2007-12-19",1.5018860895077537,1.5183395521488796],["2008-01-01",1.391407747057213,1.3280530902287562],["2008-01-17",1.1927043544690603,1.3870522526255502],["2008-02-02",1.714477505616746,1.4954405389731797],["2008-02-18",1.4980366492146597,1.6417717354913495],["2008-03-05",1.6401225114854516,1.5564417228659915],["2008-03-21",1.5605664787570466,1.6243570043924804],["2008-04-06",1.6554758045843945,1.6138163441965436],["2008-04-22",1.5767349434423725,1.5759933565828017],["2008-05-08",1.462255387664107,1.4964150144892847],["2008-05-24",1.4586004762777067,1.4155006688387748],["2008-06-09",1.3138045686841942,1.351020072028693],["2008-06-25",1.278733111072118,1.2644872699444598],["2008-07-11",1.1700706772775336,1.1516640847415847],["2008-07-27",0.9707033209591652,1.0000696908717204],["2008-08-12",0.878260675361801,0.8547444566083657],["2008-08-28",0.747764724750411,0.7602331867364789],["2008-09-13",0.7085933388467034,0.7228752875612142],["2008-09-29",0.7446589975349218,0.7043118428648163],["2008-10-15",0.673251445696678,0.6758447891706436],["2008-10-31",0.7823772326981442,0.8811703368212085],["2008-11-16",1.3297872340425532,1.2260382096890121],["2008-12-02",1.4206461104640473,1.425821633883535],["2008-12-18",1.3705238068214063,1.4017096125000146],["2009-01-01",1.4346091614127099,1.4208595803338646],["2009-01-17",1.5042566129522652,1.5412470982905502],["2009-02-02",1.6312323794075616,1.5450941289724278],["2009-02-18",1.4357470164660857,1.5219371668356034],["2009-03-06",1.542957334891876,1.5207730578856646],["2009-03-22",1.572468391137919,1.5134566186542961],["2009-04-07",1.4027018067296535,1.5052412123561778],["2009-04-23",1.600549882168107,1.5323268718452379],["2009-05-09",1.536611852311511,1.5407560930305824],["2009-05-25",1.3774220724515585,1.3662432190223806],["2009-06-10",1.2411654228240994,1.3020327310564386],["2009-06-26",1.376446740338717,1.3255102304728517],["2009-07-12",1.3217522658610272,1.3301949126722468],["2009-07-28",1.2098275220250652,1.2104041705641637],["2009-08-13",1.0749204853339616,1.074819725391333],["2009-08-29",0.9445515660013549,0.9162982621014634],["2009-09-14",0.8474167069048768,0.9236253339518428],["2009-09-30",1.141833729754219,1.0829958473987453],["2009-10-16",1.2970198073777939,1.3256111384988005],["2009-11-01",1.4686340734178618,1.4411028987669194],["2009-11-17",1.478770131771596,1.494709052343454],["2009-12-03",1.4707186239304872,1.4421879701822953],["2009-12-19",1.4018161180476731,1.4602449989332649],["2010-01-01",1.5622568093385214,1.5186796022167355],["2010-01-17",1.5605646160198183,1.5662529018036024],["2010-02-02",1.51366420606251,1.503113282522022],["2010-02-18",1.472116913293384,1.5087527536750938],["2010-03-06",1.6095781795115762,1.5947396035333767],["2010-03-22",1.6722853087295955,1.628876445005155],["2010-04-07",1.579592324705601,1.6802763829891094],["2010-04-23",1.757289994649545,1.6257591779010039],["2010-05-09",1.4565217391304346,1.5565736094431075],["2010-05-25",1.4629571741169114,1.424645553133653],["2010-06-10",1.3949940952630888,1.409975173309533],["2010-06-26",1.317999209694415,1.2960431301391402],["2010-07-12",1.1225599806611473,1.1255993101461792],["2010-07-28",0.9554181328917408,0.9872490048144125],["2010-08-13",0.9278565471226021,0.8885347087446778],["2010-08-29",0.7797979316589619,0.7926671018273184],["2010-09-14",0.7099197758818288,0.71510782862399],["2010-09-30",0.7667592505413803,0.7709198714534699],["2010-10-16",0.9383262443959075,0.9354108930781683],["2010-11-01",1.1640900688959839,1.176148657732902],["2010-11-17",1.4175324675324674,1.4011963210320595],["2010-12-03",1.5314516473654973,1.5238293420841393],["2010-12-19",1.5292341912932952,1.5352784596451248],["2011-01-01",1.523193577163247,1.529784318964257],["2011-01-17",1.5551268187180494,1.5627032457874384],["2011-02-02",1.5899389420219376,1.605729643581985],["2011-02-18",1.5041433239962652,1.3492166163027053],["2011-03-06",0.99002849002849,1.2572534018142998],["2011-03-22",1.5473612219309247,1.3602438499489498],["2011-04-07",1.5582843306814251,1.6225695134294655],["2011-04-23",1.5879766337142123,1.562928426776728],["2011-05-09",1.4516231497363574,1.4348014470256096],["2011-05-25",1.2566379783922361,1.3281964102442094],["2011-06-10",1.306688417618271,1.2280925658353743],["2011-06-26",1.0705933937445191,1.0994902668229014],["2011-07-12",0.934123437234825,0.9660025749061258],["2011-07-28",0.9459188926385632,0.8897396123317785],["2011-08-13",0.7826968316732569,0.831632043289007],["2011-08-29",0.7765992629689124,0.732058036957201],["2011-09-14",0.6888573929717788,0.7127351859382203],["2011-09-30",0.8003500649313986,0.8387476318389555],["2011-10-16",1.113381870822157,1.0786937442658704],["2011-11-01",1.1822857886969353,1.0939662205359748],["2011-11-17",0.9660896064319523,1.1558156509740707],["2011-12-03",1.4542160737812913,1.2834238522347072],["2011-12-19",1.4226174208409792,1.5295765402214492],["2012-01-01",1.639821795750514,1.597417559501201],["2012-01-17",1.6265009538772304,1.5745477747267378],["2012-02-02",1.3980427401637707,1.508249019889617],["2012-02-18",1.5759554229751789,1.4855123645406332],["2012-03-05",1.496007340541613,1.5528917700588063],["2012-03-21",1.549135846162921,1.5145474739219806],["2012-04-06",1.4626266154383514,1.4634613316817515],["2012-04-22",1.3672963334447787,1.3856914162111593],["2012-05-08",1.384223329086065,1.3913657377335806],["2012-05-24",1.4198766323249556,1.3768757205365363],["2012-06-09",1.2973971722365039,1.3589510831502642],["2012-06-25",1.3416031820939798,1.2765881168412023],["2012-07-11",1.159183934510105,1.2060785226002149],["2012-07-27",1.1153377967133293,1.1000625822420376],["2012-08-12",1.0281596082141466,1.0274466829633244],["2012-08-28",0.8939550440214451,0.8717619766435053],["2012-09-13",0.7173472404036991,0.7466528686365563],["2012-09-29",0.7618784530386741,0.7855561228338537],["2012-10-15",0.9491919415541289,0.8876511936372317],["2012-10-31",0.9246914846340546,0.9488400511977573],["2012-11-16",1.0517562533262375,1.1040402949194292],["2012-12-02",1.4120321421019244,1.349110905209792],["2012-12-18",1.4771845601784503,1.4748393036188094],["2013-01-01",1.4529600138480179,1.4930170442074273],["2013-01-17",1.572466335931963,1.550727802989286],["2013-02-02",1.6014793383918335,1.5883015746902018],["2013-02-18",1.559391050853732,1.5887566730052423],["2013-03-06",1.6193340794627866,1.6112548486440268],["2013-03-22",1.611842105263158,1.571723317037802],["2013-04-07",1.4617065021845286,1.6592676469524332],["2013-04-23",1.561771173452389,1.0083274655313175],["2013-05-09",0,0.7582143319863623],["2013-05-25",1.3212001218397806,0.83418781296582],["2013-06-10",1.2243448058099147,1.3461313152198453],["2013-06-26",1.0902175889447845,1.064496291887239],["2013-07-12",0.8787593984962406,0.9225745990313918],["2013-07-28",0.8499929607208222,0.816602370244889],["2013-08-13",0.7527636622982974,0.7736408308858098],["2013-08-29",0.7254737787943148,0.6938044765065536],["2013-09-14",0.6629586189202066,0.6995010384189407],["2013-09-30",0.829528684744512,0.8298515434980038],["2013-10-16",1.063166250850533,1.0512576747699056],["2013-11-01",1.1980869063641606,1.1819622654969861],["2013-11-17",1.207439628018599,1.2356877603269316],["2013-12-03",1.2524942026640782,1.2087400999924323],["2013-12-19",1.1649588735536038,1.2209215578786388],["2014-01-01",1.2870064151093756,1.2492716814549938],["2014-01-17",1.3079116179615111,1.3127936746850781],["2014-02-02",1.357187832041242,1.3824759175143502],["2014-02-18",1.5073910788381741,1.4765202869391738],["2014-03-06",1.5360497159889772,1.5581137330145323],["2014-03-22",1.5808513399519826,1.5568264430392702],["2014-04-07",1.5220700152207003,1.5549020980734989],["2014-04-23",1.5202702702702702,1.48576150792985],["2014-05-09",1.3529756669598358,1.3625470390698566],["2014-05-25",1.200311994453432,1.2285397950728112],["2014-06-10",1.1307390339648407,1.0797773316239148],["2014-06-26",0.88339222614841,0.919317855131649],["2014-07-12",0.7919602056359482,0.7988241944171306],["2014-07-28",0.7709992689214669,0.7380193801614724],["2014-08-13",0.6549858433851763,0.6929364484339191],["2014-08-29",0.6631617252738835,0.6208862608999137],["2014-09-14",0.5720116519323917,0.6194918517728603],["2014-09-30",0.6512341117351463,0.6065164320363012],["2014-10-16",0.6165919282511211,0.6344512489673318],["2014-11-01",0.7055541882024775,0.7649932113740554],["2014-11-17",0.9472312366222468,0.8133071230324601],["2014-12-03",0.677278148208381,0.7973720771502579],["2014-12-19",0.7937979895396714,0.7265677984261729],["2015-01-01",0.7937979895396714,0.8384809564952937],["2015-01-17",0.9586376067894099,0.9421724232175681],["2015-02-02",1.0483750187209826,1.0276065281609468],["2015-02-18",1.0151622111046317,1.0382998316775502],["2015-03-06",1.053450226244344,1.0425715451622957],["2015-03-22",1.087751199760048,1.0849504869446776],["2015-04-07",1.1694952132288947,1.1988003606495696],["2015-04-23",1.3827873310740137,1.3688793408792364],["2015-05-09",1.4698392311439834,1.4512210503302954],["2015-05-25",1.3351224768931074,1.322420439271935],["2015-06-10",1.1003207412687097,1.1429484756796575],["2015-06-26",1.0353081361317835,0.9986041530081889],["2015-07-12",0.9126352052155875,0.9317673720796729],["2015-07-28",0.9330656286953094,0.9296168757838655]]});
		response.end();
		/*
	  	var lon = request.param('longitude');
	  	var lat = request.param('latitude');
	  	var id = request.param('id');
		
		var path ="python "+config.pathTimeSeries+" "+id+" "+lon+" "+lat+" "+config.pathPythonIni;
		

		console.log(path);
		
		ls = ChildProcess.exec(path, function (error, stdout, stderr) {
				
				if(stderr) {
					console.log(stderr)
				}
				
		   	stdout=stdout.replace(/\'/g, '"');
		 	
		   	var result = JSON.parse(stdout);
		   	
		   	response.send(result);		   	
		   	response.end();

	 	});
		*/
	};

	TimeSerie.byId = function(request, response){

		var timeSeriesCollection = app.repository.collections.timeSeries;

		var id = request.param('id');

		timeSeriesCollection.findOne({_id : id}, function(err, timeSeries) {
			response.send(timeSeries);
			response.end()
		})
	};

	TimeSerie.tree = function(request, response) {
		
		var timeSeriesCollection = app.repository.collections.timeSeries;

		var projects = request.param('projects', '').toUpperCase().split(',')

		timeSeriesCollection.distinct('subject', { 'project': { $in: projects } }, function(err,subjects) {

			var result = [];
			console.log(projects)
			var interate = function(subject, next){
				var subjectObj = {
							text:subject,
							iconCls: 'task-folder'
					};

				timeSeriesCollection.find({ 'subject': subject, 'project': { $in: projects } }).toArray(function (err, timeSeries){
					
					var childrens = [];
					timeSeries.sort(function(a,b) {
						var aText = unidecode(a.name);
						var baText = unidecode(b.name);

						if(aText < baText) return -1;
				    if(aText > baText) return 1;
				    return 0;
					})

					for(i in timeSeries){
						var layer = timeSeries[i];
						var children = {
						     text: layer.name,
						     id: layer._id,
						     leaf:true,
						     iconCls:'task'
					 }

						childrens.push(children);
					}

					subjectObj['children'] = childrens;

					result.push(subjectObj);
					next();
				});

			}

			var finalize = function(){

				result.sort(function(a,b) {
					var aText = unidecode(a.text);
					var baText = unidecode(b.text);

					if(aText < baText) return -1;
			    if(aText > baText) return 1;
			    return 0;
				})

				response.send(result);
				response.end();
			}

			async.each(subjects, interate, finalize);

		});

	};
	
	TimeSerie.chart = function(request, response) {
  
	  response.connection.setTimeout(0);

	  var lineLayer = request. param('lineLayer', '');
	  var barLayer = request. param('barLayer', '');
	  var lat = request. param('lat', -16.4804);
	  var lon = request. param('lon', -48.8232);

	  var result = {
	      bar: {},
	      line: {},
	      value: {}
	  };
	  var data = {};

	  rasterTimeSeries.pixelValue(lineLayer, lat, lon, function(lineResult) {
	    rasterTimeSeries.pixelValue(barLayer, lat, lon, function(barResult) {

	      if(lineResult) {

	        result.line = {
	          key: lineResult.key,
	          name: lineResult.name
	        };

	        for (var strDate in lineResult.values) {
	            var name = lineResult.name;

	            if(!result.value[strDate])
	              result.value[strDate] = { lon: lon, lat: lat, strDate: strDate};

	            result.value[strDate].date = lineResult.values[strDate][0];
	            result.value[strDate][name] = lineResult.values[strDate][1];
	        }

	      }

	      if(barResult) {

	        result.bar = {
	          key: barResult.key,
	          name: barResult.name
	        };

	        for (var strDate in barResult.values) {
	            var name = barResult.name;

	            if(!result.value[strDate])
	              result.value[strDate] = { lon: lon, lat: lat, strDate: strDate};

	            result.value[strDate].date = barResult.values[strDate][0];
	            result.value[strDate][name] = barResult.values[strDate][1];
	        }
	      }

	      var valuesArray = [];
	      for (var i in result.value)
	        valuesArray.push(result.value[i]);

	      valuesArray.sort(function(a, b ){
	        return a.date - b.date;
	      });

	      result.value = valuesArray;

	      response.render('chart-page.ejs', { resultado: result });

	    });
	  });

	};
	
	return TimeSerie;
}